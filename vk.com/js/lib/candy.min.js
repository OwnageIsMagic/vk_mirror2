function Candy(e) {
    function a() {
        c.stop()
    }

    function b() {
        clearInterval(f);
        clearInterval(g);
        clearTimeout(h);
        c.H();
        d = c = null
    }
    var c, d = {},
        f, h, g, l = {
            video: void 0,
            streamKey: void 0
        },
        p = Date.now().toString(16);
    Candy.scopes[p] = d;
    d.sc = r;
    if (void 0 === e.streamKey) throw Error('parameter "streamKey" is required');
    if (!e.getVideo) {
        if (!e.video) throw Error("element video not found in config");
        if (void 0 === e.video.currentTime || void 0 === e.video.buffered) throw Error("element video is not video");
    }(function(a) {
        for (var d in l) void 0 ===
            a[d] && (a[d] = l[d])
    })(e);
    d.s = e;
    if (!1 === Candy.a.K.Ka()) throw Error("Candy not support in your browser");
    c = new Candy.a.K(d);
    c.Tb = function() {
        clearTimeout(h);
        h = setTimeout(a, 3E4)
    };
    g = setInterval(function() {
        if (c && c.enabled) {
            var a = {
                candy: {}
            };
            a.candy.v = Candy.version;
            a.candy.peerid = d.p2pstats.myId();
            a.candy.srvloaded = Math.round(c.Db() / 1024 / 1024);
            a.candy.peersloaded = Math.round(c.Cb() / 1024 / 1024);
            var b = d.p2pstats.collectGoodAndBadPeers();
            a.candy.goodpeers = b.Hb;
            a.candy.badpeers = b.hb;
            a instanceof Object || (a = {
                0: a
            });
            a.q = "720";
            a.p2p = c.va() ? 1 : 0;
            Candy.c.F.ia().dispatchEvent(Candy.a.i.g.za, "viewing_params", a)
        }
    }, 3E5);
    f = setInterval(function() {
        e.video && !1 === document.contains(e.video) && b()
    }, 5E3);
    var r = {
        xhrLoader: function() {
            return c ? c.Pb() : void 0
        },
        hlsJsLoader: function() {
            var a;
            if (a = c) {
                a = e.video;
                if (!a || void 0 === a.currentTime || void 0 === a.buffered) throw Error("element video is undefined or not video");
                a = !0
            }
            if (a) return c.Ib(e.video)
        },
        getScope: function() {
            return Candy.scopes[p]
        },
        setStreamKey: function(a) {
            if (a && "" !== a.toString().trim()) d.s.streamKey =
                a, c && c.Qa();
            else throw "StreamKey should be a string";
        }
    };
    r.destroy = b;
    return r
}
window.Candy = Candy;
Candy.version = "T54";
Candy.scopes = {};
Candy.xc = {};
Candy.a = {};
Candy.c = {};
Candy.a.f = function() {
    var e = {};
    return {
        B: e,
        ub: Date.now(),
        J: [],
        wb: function(a, b) {
            var c = new Uint8Array(a.byteLength + Candy.a.f.G);
            c.set(Candy.a.f.oa.encode(b), 0);
            c.set(new Uint8Array(a), Candy.a.f.G);
            a = c;
            this.ha = b;
            c = Candy.c.j.Gb(b);
            this.O = c.id;
            this.P = c.type;
            var c = 0,
                d = a.byteLength,
                f = 0;
            for (this.C = Math.ceil(d / Candy.a.f.o); c <= d;) {
                var h;
                f++;
                h = c + Candy.a.f.o < d ? a.slice(c, c + Candy.a.f.o) : a.slice(c);
                c += Candy.a.f.o;
                h = (new Candy.a.D(h)).Oa(f, this.C, this.O, this.P);
                this.X(h)
            }
            this.loaded = !0
        },
        wa: function() {
            return this.loaded ||
                Object.keys(this.B).length === this.C
        },
        Ha: function() {
            var a = 0,
                b = this.gb(),
                c;
            for (c in b) a += b[c].byteLength;
            this.fa = new Uint8Array(a);
            a = 0;
            for (c in b) {
                var d = b[c];
                this.fa.set(new Uint8Array(d), a);
                a += d.byteLength
            }
            this.ha = Candy.a.f.Da.decode(new DataView(this.fa.buffer.slice(0, Candy.a.f.G)));
            0 < this.ha.length && (this.ha = this.ha.replace(/\0/g, ""));
            this.I = this.fa.buffer.slice(Candy.a.f.G);
            delete this.fa
        },
        X: function(a) {
            this.C = a.Ga;
            this.B[a.T] = a
        },
        gb: function() {
            var a = [],
                b;
            for (b in e) a.push(e[b].I);
            return a
        },
        pc: function() {
            return Object.keys(this.B).length /
                this.C
        },
        loaded: !1,
        H: function() {
            for (var a in e) e[a].H();
            e = null
        }
    }
};
Candy.a.f.G = 200;
Candy.a.f.o = Math.pow(2, 14) - Candy.a.f.G;
Candy.a.f.nc = 1;
Candy.a.f.mc = 2;
Candy.a.f.oa = new TextEncoder("utf-8");
Candy.a.f.Da = new TextDecoder("utf-8");
Candy.a.D = function(e) {
    return {
        Oa: function(a, b, c, d) {
            this.T = a;
            this.Ga = b;
            this.O = c;
            this.P = d;
            var f = {};
            f.chunkNumber = a;
            f.allChunks = b;
            f.messageId = c;
            f.messageType = d;
            e && (f.packetSize = e.byteLength + Candy.a.D.W, a = JSON.stringify(f), b = new Uint8Array(e.byteLength + Candy.a.D.W), b.set(new Uint8Array(Candy.a.f.oa.encode(a)), 0), b.set(new Uint8Array(e), Candy.a.D.W), this.U = b.buffer);
            return this
        },
        yb: function() {
            this.U = e;
            var a = e.slice(0, Candy.a.D.W);
            try {
                var b = Candy.a.f.Da.decode(new Uint8Array(a)),
                    b = b.slice(0, b.indexOf("}") +
                        1),
                    c = JSON.parse(b.slice(0, b.lastIndexOf("}") + 1));
                this.T = c.chunkNumber;
                this.Ga = c.allChunks;
                this.O = c.messageId;
                this.P = c.messageType;
                if (c.packetSize != e.byteLength) return !1;
                this.I = e.slice(Candy.a.D.W);
                return this
            } catch (d) {
                return !1
            }
        },
        Zb: function(a) {
            this.I = a
        },
        H: function() {}
    }
};
Candy.a.D.W = 200;
Candy.c.Sa = function(e, a, b, c, d) {
    function f() {
        n = 0;
        k && Candy.b.warn("phase 0 started", e, a.u);
        m(function() {
            if (!a.u.length || u.length) return !1;
            k && Candy.b.log("asking ", a.u, e);
            for (var d = !1, b = 0; b < a.u.length; b++) a.send(a.u[b], A) && (d = !0);
            if (!d) return Candy.b.warn("phase 0 aborted"), !1
        }, 500, 5, function() {
            u.length || h()
        })
    }

    function h() {
        n = 1;
        a.u = [];
        k && Candy.b.warn("phase 1 started", e);
        for (var d in B) {
            var b = B[d];
            v.push(b.id);
            a.send(b.id, A)
        }
        C = setTimeout(g, 2E3)
    }

    function g() {
        3 == n ? Candy.b.log("Already downloading...") :
            (clearTimeout(C), C = 0, k && Candy.b.log("interestedPhaseDone, fails:", v.length), u.length ? r() : z.length ? l() : d(!1))
    }

    function l() {
        Candy.b.warn("Have loading peers, waiting...");
        setTimeout(function() {
            n = 2;
            if (w) return !1;
            k && Candy.b.warn("phase 2 started", e);
            for (var d = 0; d < z.length; d++) {
                var b = B[z[d]];
                v.push(b.id);
                a.send(b.id, A)
            }
            D = setTimeout(p, 2E3)
        }, 2E3)
    }

    function p() {
        clearTimeout(D);
        k && Candy.b.log("loadingPhaseDone");
        u.length ? r() : d(!1)
    }

    function r() {
        n = 3;
        k && Candy.b.log("Phase 3 downloading", u);
        G = Date.now();
        var d,
            b;
        m(function() {
            var c;
            if (!(c = a.m.Ja(e))) {
                c = x;
                for (var f = [], g = 0; g <= c; g++) f.push(g);
                c = f
            }
            d = c;
            if (0 == d.length || 4 > d.length && b == d.length) return !1;
            b = d.length;
            c = 0;
            for (var g = d, h = 5 <= u.length ? 3 : 5, f = [], v = 1; v < g.length; v += h) f.push(g.slice(v, v + h));
            for (k && Candy.b.log("phase", n, e, "asking " + u.length + " peers ", d); f.length;) g = f.shift(), a.send(u[c], t(g)), c++, c >= u.length && (c = 0)
        }, 1E3, 4, function() {
            y || (k && Candy.b.warn("download failed!"), u.length = 0, h())
        })
    }

    function t(a) {
        var d = {};
        d.filename = e;
        d.chunks = a;
        return JSON.stringify({
            type: "chunk2",
            request: d
        })
    }

    function m(a, d, b, c) {
        function f() {
            if (w) return !1;
            g++;
            if (!1 !== a() && (!b || g <= b)) setTimeout(f, d);
            else return c && c()
        }
        var g = 0;
        f()
    }
    for (var k = a.vb, n = 0, x = 0, w = !1, y = !1, A = JSON.stringify({
            type: "interested2",
            filename: e
        }), v = [], C = 0, u = [], z = [], D = [], G = 0, B = {}, E = 0; E < b.length; E++) {
        var H = b[E];
        B[H.id] = H
    }
    a.u.length ? f() : h();
    return {
        handleResponse: function(d, b) {
            k && Candy.b.log("phase", n, d, b);
            "have" == b.type && (x = b.allChunks, u.push(d), g());
            2 != n && "loading" == b.type && (z.push(d), -1 == a.u.indexOf(d) && a.u.push(d));
            0 == n && u.length &&
                g();
            if (1 == n) {
                var c = v.indexOf(d); - 1 < c && v.splice(c, 1);
                0 == v.length && g()
            }
            2 == n && (c = z.indexOf(d), -1 < c && z.splice(c, 1), 0 == z.length && p())
        },
        success: function(a) {
            k && Candy.b.info("p2p success", e, Date.now() - G);
            y = !0;
            c(a)
        },
        abort: function() {
            Candy.b.info("p2p fail", e);
            w = !0;
            clearTimeout(C);
            clearTimeout(D)
        }
    }
};
Candy.c.Ta = function() {
    var e;
    this.w = {};
    this.X = function(a, b) {
        var c = new Candy.a.D(a);
        if (!c.yb()) return !1;
        var d = Candy.c.j.getFileName(c.P, c.O),
            f = this.N(d),
            h = {
                ready: !1
            };
        void 0 === f && (f = new Candy.a.f, f.P = c.P, f.O = c.O, f.J = [], this.w[d] = f);
        var g; - 1 == f.J.indexOf(b) && f.J.push(b);
        f.loaded ? g = !1 : (f.X(c), f.wa() && (f.Ha(), h.ready = !0, h.data = f.I), g = !0);
        h.filename = d;
        h.pb = c.T;
        h.loaded = Object.keys(f.B).length;
        h.total = f.C;
        h.oc = g;
        h.J = f.J;
        return h
    };
    this.fb = function(a, b, c) {
        var d = Candy.c.j.M(a),
            f = new Candy.a.f;
        f.wb(b, a);
        this.w[d] =
            f;
        c && Candy.b.warn(f)
    };
    this.N = function(a) {
        return this.w[a]
    };
    this.sa = function(a, b) {
        var c = !1,
            d = this.N(a);
        d && (c = d.B[b]);
        return c
    };
    this.Ja = function(a) {
        if (a = this.N(a)) {
            for (var b = [], c = 1; c <= a.C; c++) a.B[c] || b.push(c);
            return b
        }
        return !1
    };
    this.Ab = function(a) {
        var b = !1,
            c = this.N(a);
        c && (b = Object.keys(c.B).map(function(a) {
            return c.B[a]
        }));
        return b
    };
    this.qb = function() {
        var a = Date.now(),
            b;
        for (b in this.w) 3E4 <= a - this.w[b].ub && delete this.w[b]
    };
    this.H = function() {
        clearInterval(e);
        for (var a in this.w) this.w[a].H();
        this.w = {}
    };
    e = setInterval(this.qb.bind(this), 1E4);
    this.Bb = function(a) {
        a = this.w[a];
        var b = !1;
        a && (b = {}, b.chunks = Object.keys(a.B), b.allChunks = a.C);
        return b
    };
    return this
};
Candy.a.K = function(e) {
    var a = new Candy.a.Za(e.s),
        b = 0,
        c = 0,
        d = {},
        f;
    this.files = [];
    this.enabled = !1;
    this.l = a;
    this.s = e.s;
    this.start = function() {
        this.enabled = !0;
        f || (f = new Candy.a.i);
        f.Kb();
        a.connect()
    };
    this.stop = function() {
        this.enabled = !1;
        a.disconnect();
        f && f.close()
    };
    this.Qa = function() {
        a.disconnect();
        a.connect()
    };
    this.Pb = function() {
        q.ka = this;
        q.video = e.s.getVideo || e.s.video;
        return F
    };
    this.Ib = function(a) {
        q.ka = this;
        q.video = a;
        return q
    };
    this.bc = function(d) {
        a.ac(d)
    };
    this.xb = function(d, b, c) {
        a.Nb(d, b, c)
    };
    this.Lb = function(d,
        b, c) {
        a.Wb(d, b, c)
    };
    this.Db = function() {
        var d = a.L - b;
        b = a.L;
        return d
    };
    this.Cb = function() {
        var d = a.ca - c;
        c = a.ca;
        return d
    };
    this.Fb = function() {
        return a.Y || ""
    };
    this.va = function() {
        return Candy.a.K.va()
    };
    this.H = function() {
        a.H();
        this.stop();
        for (var b in d) d[b].abort()
    };
    this.zb = function(a) {
        d[a.url] = a;
        this.Tb()
    };
    this.Ia = function(a) {
        if (Candy.c.j.aa(a.url)) {
            Candy.b.log("Loaded callback", a.R, a.S);
            if (e && void 0 !== e.s && void 0 !== e.s.loadedCallback) {
                var b = {};
                b.p2pBytes = a.R;
                b.cdnBytes = a.S;
                b.url = a.url;
                e.s.loadedCallback(b)
            }
            delete d[a.url]
        }
    };
    var h = {};
    h.myId = this.Fb.bind(this);
    h.streamKey = function() {
        return a.dc.cc()
    };
    h.sent = function() {
        return a.da
    };
    h.p2p = function() {
        return a.ca
    };
    h.cdn = function() {
        return a.L
    };
    h.collectGoodAndBadPeers = function() {
        return a.rb()
    };
    h.getPeers = function() {
        return a.$().map(function(d) {
            return a.peers[d]
        })
    };
    e.p2pstats = h
};

function q() {
    this.load = function(e, a, b) {
        a = new F(q.ka);
        var c = e.url,
            d = e.responseType,
            f = b.onSuccess;
        a.open("GET", c, !0);
        a.responseType = d;
        a.timeout = d ? 2E4 : 1E4;
        a.onreadystatechange = function(a) {
            4 == this.readyState && this.response && (a.currentTarget || (a.currentTarget = {
                response: this.response
            }), f({
                url: c,
                data: this.response
            }, {}, e))
        };
        a.send()
    };
    this.abort = function() {
        Candy.b.log("abort")
    };
    this.destroy = function() {
        Candy.b.log("destroy")
    }
}
q.ka = !1;

function F(e) {
    var a = e || q.ka;
    this.h = null;
    this.Na = !1;
    this.requestTime = this.R = this.S = 0;
    this.responseType = "arraybuffer";
    this.timeout = void 0;
    this.onreadystatechange = function() {};
    this.ontimeout = this.onerror = this.onload = this.onprogress = void 0;
    this.Fa = !1;
    this.setRequestHeader = function() {
        Candy.b.log(arguments)
    };
    this.addEventListener = function(a, c) {
        "load" == a && (this.onload = c)
    };
    this.mb = !1;
    this.Z = 0;
    this.ja = function() {
        clearTimeout(this.Z);
        if (this.Fa || this.Na) return !1;
        this.Fa = !0;
        "arraybuffer" === this.responseType &&
            Candy.c.j.aa(this.url) && a.bc(Candy.c.j.M(this.url));
        this.h = "undefined" != typeof ggXMLHttpRequest ? new ggXMLHttpRequest : new XMLHttpRequest;
        this.h.open(this.method, this.url, this.async);
        this.h.responseType = this.responseType;
        this.h.onreadystatechange = this.jb.bind(this);
        this.h.onprogress = this.onprogress;
        this.h.onerror = this.onerror;
        this.h.ontimeout = this.ontimeout;
        this.h.send();
        this.requestTime = Date.now()
    };
    this.Ma = function() {
        var b = Candy.c.j.M(this.url);
        a.l.A[b] && (a.l.A[b].abort(), delete a.l.A[b]);
        if (Candy.c.ea.active) {
            var c =
                a.l.m.Ja(b);
            if (c) return 0 == c.length && Candy.b.error("!!!! not completed", a.l.m.N(b), "payload", a.l.m.N(b).I), Candy.b.info("Range request:", c.length, "chunks", this.R), this.Mb(b)
        }
        this.ja()
    };
    this.Mb = function(b) {
        b = a.l.m.N(b);
        if (b.wa()) Candy.b.log("!!!!!", b, "*mess payload:", b.I), void 0 === b.I ? (Candy.b.info("fatal fatalbI4 drop to cdn"), this.ja()) : this.ra(b.I);
        else {
            var c = new Candy.c.ea(this, b, this.ra.bind(this), this.ja.bind(this));
            this.S = this.R = 0;
            for (var d = 1; d <= b.C; d++) b.B[d] ? this.R += Candy.a.f.o : (c.sa(d), a.l.L +=
                Candy.a.f.o, this.S += Candy.a.f.o)
        }
    };
    this.jb = function() {
        if (4 == this.h.readyState && this.h.response && this.onreadystatechange) {
            this.readyState = 4;
            this.response = this.h.response;
            this.status = 200;
            "arraybuffer" === this.responseType && Candy.c.j.aa(this.url) && (a.l.$().length && (a.l.L += this.h.response.byteLength, this.S = this.h.response.byteLength, a.Ia(this)), a.xb(this.url, this.h.response, this.mb));
            this.onreadystatechange({});
            if (this.onload) this.onload();
            try {
                delete this.h.response, delete this.h
            } catch (b) {}
        }
    };
    this.Vb =
        function() {
            if (this.onprogress) this.onprogress({
                loaded: 100,
                total: 100
            })
        };
    this.ra = function(b) {
        Candy.b.log("endLoadingWithP2P", b, "byteLength:", b ? b.byteLength : b);
        clearTimeout(this.Z);
        if (this.onreadystatechange && (this.Vb(), this.Na = !0, this.readyState = 4, this.response = b, this.status = 200, this.R = b.byteLength, a.Ia(this), this.onreadystatechange({}), this.onload)) this.onload()
    };
    this.open = function(a, c) {
        this.method = a;
        this.url = c;
        this.async = !0
    };
    this.send = function() {
        a.zb(this);
        "function" == typeof q.video && (q.video = q.video());
        this.qa = q.video && q.video.currentTime && 0 < q.video.buffered.length ? q.video.buffered.end(q.video.buffered.length - 1) - q.video.currentTime || 0 : 0;
        if (Candy.c.j.aa(this.url)) {
            var b = Candy.c.j.M(this.url);
            "" != a.s.qualityKey && (Candy.b.warn('qualityKey key has been changed! Updating to ""'), a.s.qualityKey = "", a.Qa(), a.enabled || a.start());
            Candy.b.log("candyTimeout: ", this.qa);
            if (a.enabled && 3 < this.qa && a.l.$().length && "arraybuffer" === this.responseType && Candy.c.j.aa(this.url)) {
                this.Z = setTimeout(this.Ma.bind(this), 1E3 *
                    (this.qa - 2), "timer");
                Candy.b.log("try loading file with p2p", b);
                this.requestTime = Date.now();
                a.Lb(Candy.c.j.M(this.url), this.ra.bind(this), this.Ma.bind(this));
                return
            }
        }
        this.ja()
    };
    this.abort = function() {
        this.h && (this.h.abort(), delete this.h);
        this.Z && clearTimeout(this.Z)
    };
    this.getAllResponseHeaders = function() {
        return this.h ? this.h.getAllResponseHeaders() : ""
    };
    return this
}
F.rc = function() {
    var e = [];
    return {
        add: function(a) {
            e.push(a);
            100 < e.length && e.shift()
        },
        qc: function() {
            var a = 0,
                b;
            for (b in e) a += e[b];
            return 0 < e.length ? Math.floor(a / e.length) : 0
        },
        max: function() {
            var a = 0,
                b;
            for (b in e) a < e[b] && (a = e[b]);
            return a
        }
    }
}();
Candy.a.K.va = function() {
    return !0
};
Candy.a.K.Ka = function() {
    var e = window;
    e.PeerConnection = e.webkitRTCPeerConnection || e.mozRTCPeerConnection;
    e.SessionDescription = e.RTCSessionDescription || e.mozRTCSessionDescription;
    e.IceCandidate = e.RTCIceCandidate || e.mozRTCIceCandidate;
    return !!e.PeerConnection && !!e.SessionDescription && !!e.IceCandidate && !!e.TextEncoder
};
Candy.a.K.g = {
    $a: "p2p_toggle"
};
Candy.c.j = function() {
    var e = {
        ic: 1,
        hc: 2,
        aa: function(a) {
            return -1 == a.indexOf("init") && -1 == a.indexOf(".mpd") && -1 == a.indexOf(".idx") && -1 == a.indexOf(".hdr")
        },
        getFileName: function(a, b) {
            return b
        },
        Gb: function(a) {
            var b = {};
            b.id = e.M(a);
            b.type = 1;
            return b
        },
        M: function(a) {
            -1 != a.indexOf("?") && (a = a.slice(0, a.indexOf("?")));
            a = a.split("/");
            return a.splice(a.length - 2, 2).join("/")
        },
        uc: function() {
            return ""
        }
    };
    return e
}();
Candy.c.Wa = {
    iceServers: ["stun:stun.l.google.com:19302"],
    optional: {
        optional: []
    },
    tb: {
        optional: [],
        mandatory: {}
    },
    ib: 2E7
};
Candy.c.Aa = function(e, a) {
    function b(a) {
        try {
            "open" === n.readyState && n.send(a)
        } catch (d) {}
    }

    function c() {
        k = new PeerConnection(t(x.iceServers), x.optional);
        k.onicecandidate = p;
        k.ondatachannel = l
    }

    function d() {
        n && n.close();
        k && "closed" !== k.signalingState && k.close();
        a.kb(m.id);
        k = n = null
    }

    function f(d) {
        m.La = Date.now();
        var c = d.data instanceof ArrayBuffer ? ArrayBuffer.name : "string" === typeof d.data ? String.name : null;
        c === ArrayBuffer.name ? (a.Rb(m.id, d.data), m.score += 1, m.loadedBytes += d.data.byteLength) : c === String.name &&
            (c = d.data.substr(0, 4), "ping" === c ? b("pong") : "pong" === c ? (d = Date.now() - w, m.score -= d, m.active = !0, a.lb(m.id), Candy.V.eb(m.id, y, d)) : a.Sb(m.id, d.data))
    }

    function h() {
        d()
    }

    function g() {
        w = Date.now();
        b("ping$" + Array(2048).join("x"))
    }

    function l(a) {
        n = a.channel;
        n.binaryType = "arraybuffer";
        n.onopen = g;
        n.onclose = h;
        n.onmessage = f
    }

    function p(d) {
        d.candidate && null != d.candidate ? (a.ua(m.id, "candidate", d.candidate), y.push(d.candidate.candidate)) : "offer" === d.type ? a.ua(m.id, "offer", d) : "answer" === d.type && a.ua(m.id, "answer", d)
    }

    function r(a) {
        return a.replace(/a=mid:data\r\n/g, "a=mid:data\r\nb=AS:" + x.ib + "\r\n")
    }

    function t(a) {
        return {
            iceServers: a.map(function(a) {
                return {
                    url: a
                }
            })
        }
    }
    var m = this,
        k = void 0,
        n = void 0,
        x = Candy.c.Wa,
        w = 0,
        y = [];
    this.id = e;
    this.active = !1;
    this.score = 1E3;
    this.loadedBytes = 0;
    this.La = Date.now();
    this.close = d;
    this.Pa = function(a, d) {
        switch (a) {
            case "candidate":
                var b = new IceCandidate({
                    sdpMLineIndex: d.sdpMLineIndex,
                    candidate: d.candidate
                });
                k.addIceCandidate(b, function() {}, function() {});
                break;
            case "answer":
                k.setRemoteDescription(new SessionDescription(d),
                    function() {},
                    function() {})
        }
    };
    this.send = b;
    if (2 < arguments.length) {
        var A = arguments[2];
        c();
        k.setRemoteDescription(new SessionDescription(A)).then(function() {
            k.createAnswer(function(a) {
                a.sdp = r(a.sdp);
                k.setLocalDescription(a);
                p(a)
            }, function() {})
        })["catch"](function() {})
    } else c(), n = k.createDataChannel(this.id, {
        ordered: !0,
        negotiated: !1
    }), l({
        channel: n
    }), k.createOffer(function(a) {
        a.sdp = r(a.sdp);
        k.setLocalDescription(a);
        p(a)
    }, function() {}, x.tb);
    return this
};
Candy.c.ea = function(e, a, b, c) {
    function d(d) {
        var c = d.currentTarget;
        if (4 == c.readyState && c.response) {
            d = c.response.slice(0, Candy.a.f.o);
            if (1 == c.T) {
                var g = new Uint8Array(d.byteLength + Candy.a.f.G);
                g.set(Candy.a.f.oa.encode(e.url), 0);
                g.set(new Uint8Array(d), Candy.a.f.G);
                d = g
            }
            c = (new Candy.a.D).Oa(c.T, a.C, a.O, a.P);
            c.Zb(d);
            a.X(c);
            a.wa() && (Candy.b.log("Message completed! Success downloading"), a.Ha(), b(a.I))
        }
    }
    return {
        sa: function(b) {
            var h = 0,
                g;
            1 == b ? g = Candy.a.f.o - Candy.a.f.G - 1 : (h = (b - 1) * Candy.a.f.o - Candy.a.f.G, g = h + Candy.a.f.o -
                1);
            b == a.C && (g = "");
            var l = "undefined" != typeof ggXMLHttpRequest ? new ggXMLHttpRequest : new XMLHttpRequest;
            l.open(e.method, e.url, !0);
            l.setRequestHeader("Range", "bytes=" + h + "-" + g);
            l.responseType = e.responseType;
            l.onreadystatechange = d;
            l.onerror = function() {
                Candy.c.ea.active = !1;
                c("range error")
            };
            l.ontimeout = c;
            l.T = b;
            l.send()
        }
    }
};
Candy.c.ea.active = !0;
Candy.a.Va = function() {
    function e(a) {
        var d = [],
            b;
        for (b in a) d.push(a[b]);
        return d
    }
    var a = {},
        b;
    a.timestamp = 0;
    a.performance = 0;
    a.goodPeers = {};
    a.badPeers = {};
    setInterval(function() {
        var c = JSON.parse(JSON.stringify(a));
        c.timestamp = Date.now();
        for (var d = performance.now(), f = 0; 9 > f; f++);
        c.performance = (1E3 * (performance.now() - d)).toFixed(0);
        c.goodPeers = e(c.goodPeers);
        c.badPeers = e(c.badPeers);
        b && b.Xb(c)
    }, 3E5);
    return {
        Yb: function(b) {
            a.webrtc_id = b
        },
        eb: function(b, d, f) {
            d = {};
            d.webrtc_id = b;
            d.ping = f;
            d.bytes = 0;
            d.chunk_rate =
                0;
            a.goodPeers[b] = d
        },
        cb: function(b) {
            var d = {};
            d.webrtc_id = b;
            d.drop_timestamp = Date.now();
            a.badPeers[b] = d
        },
        Jb: function(b, d) {
            a.goodPeers[b].bytes += d
        },
        $b: function(a) {
            b = a
        },
        wc: function(a, d) {
            (new Image).src = "https://candy.goodgame.ru/blank.gif?ver=" + Candy.version + "&p2p=" + a + "&cdn=" + d + "&random=" + Date.now()
        },
        tc: function() {
            return a
        }
    }
};
Candy.V = new Candy.a.Va;
Candy.a.Za = function(e) {
    var a = {},
        b = null,
        c = {};
    this.pa = this.ta = this.L = this.ca = this.da = 0;
    this.Y = void 0;
    this.m = new Candy.c.Ta;
    this.la = void 0;
    this.ma = 30;
    this.Ra = 3E4;
    this.Ua = 2;
    this.peers = a;
    this.A = {};
    this.ba = {};
    this.u = [];
    this.vb = !0;
    this.fc = function(a, b, c) {
        switch (a) {
            case "connected":
                this.Y = b;
                Candy.V.Yb(this.Y);
                Candy.b.log("Candy id: " + this.Y);
                break;
            case "peers":
                if (b && 0 < b.length)
                    for (a = 0; 0 != b.length;) setTimeout(this.Qb.bind(this, b.splice(0, this.Ua)), 1500 * a++);
                break;
            case "message":
                this.ec(b, c, c.type)
        }
    };
    this.ua =
        function(a, c, e) {
            switch (c) {
                case "candidate":
                    b.send(a, {
                        type: c,
                        candidate: e
                    });
                    break;
                case "offer":
                    b.send(a, {
                        type: c,
                        sdp: e
                    });
                    break;
                case "answer":
                    b.send(a, {
                        type: c,
                        sdp: e
                    })
            }
        };
    this.ec = function(d, e, h) {
        switch (h) {
            case "candidate":
                var g = a[d];
                g && g.Pa(h, e.candidate);
                break;
            case "offer":
                this.$().length < this.ma ? (a[d] && this.ga(d), g = new Candy.c.Aa(d, this, e.sdp), a[d] = g) : b.send(d, {
                    type: "reject",
                    n: 1
                });
                break;
            case "answer":
                (g = a[d]) && g.Pa(h, e.sdp);
                break;
            case "reject":
                (g = a[d]) && this.ga(d), delete c[d]
        }
    };
    this.Qb = function(d) {
        for (var b in d) {
            var e =
                d[b];
            if (Object.keys(a).length < this.ma && "undefined" != e && e !== this.Y && !a[e]) {
                var g = new Candy.c.Aa(e, this);
                a[e] = g;
                c[e] = {
                    xa: !1,
                    start: Date.now()
                }
            }
        }
    };
    this.$ = function() {
        return Object.keys(a).filter(function(d) {
            return !0 === a[d].active
        })
    };
    this.ob = function() {
        this.$().length < this.ma && b.Eb()
    };
    this.connect = function() {
        b.connect();
        this.la && clearInterval(this.la);
        this.la = setInterval(this.ob.bind(this), this.Ra)
    };
    this.disconnect = function() {
        clearInterval(this.la);
        b.disconnect();
        for (var d in a) this.ga(d)
    };
    this.H = function() {
        this.disconnect();
        this.m.H();
        var a = Object.keys(this.A),
            b;
        for (b in a) {
            var c = a[b];
            this.A[c].abort();
            delete this.A[c];
            delete this.ba[c]
        }
    };
    this.Rb = function(a, b) {
        var c = this.m.X(b, a);
        if (c) {
            var e = c.filename;
            Candy.V.Jb(a, b.byteLength);
            this.ca += b.byteLength;
            this.u = c.J;
            !0 === c.ready && this.Ob(e, c.data, c.J)
        } else log("Wrong packet!"), this.ga(a)
    };
    this.Sb = function(a, b) {
        try {
            var c = JSON.parse(b)
        } catch (e) {
            return
        }
        switch (c.type) {
            case "interested2":
                var g = c.filename,
                    l = this.m.Bb(g),
                    p = {
                        type: "choke2",
                        filename: g,
                        vc: Object.keys(this.m.w).pop()
                    };
                this.ba[g] && (p.type = "loading");
                l && (p.type = "have", p.allChunks = l.allChunks);
                this.send(a, JSON.stringify(p));
                break;
            case "choke2":
            case "loading":
            case "have":
            case "chunk2choke":
                this.A[c.filename] && this.A[c.filename].handleResponse(a, c);
                break;
            case "request2":
                if (l = this.m.Ab(c.filename))
                    for (p in l) {
                        var r = l[p];
                        r && (this.da += r.U.byteLength, this.send(a, r.U))
                    }
                break;
            case "chunk2":
                var t = this;
                c.request.chunks.forEach(function(b) {
                    var e = t.m.sa(c.request.filename, b);
                    e && e.U ? (t.da += e.U.byteLength, t.send(a, e.U)) : t.send(a, {
                        type: "chunk2choke",
                        pb: b,
                        filename: g
                    })
                })
        }
    };
    this.lb = function(a) {
        c[a] && (c[a].xa = !0)
    };
    this.rb = function() {
        var a = Date.now(),
            b;
        for (b in c) {
            var e = c[b];
            !0 === e.xa ? (this.ta++, delete c[b]) : !1 === e.xa && 6E3 < a - e.start && (Candy.V.cb(b, ""), this.pa++, delete c[b])
        }
        a = {
            Hb: this.ta,
            hb: this.pa
        };
        this.ta = this.pa = 0;
        return a
    };
    this.kb = function(b) {
        delete this.Ub[b];
        delete a[b]
    };
    this.ga = function(b) {
        a[b] && a[b].close();
        delete a[b]
    };
    this.send = function(b, c) {
        if (a[b] && a[b].active) return a[b].send(c), !0;
        Candy.b.warn("Peer send fail: peer ",
            a[b] ? a[b].active ? "???" : "not active" : "missing");
        return !1
    };
    this.Wb = function(b, c, e) {
        var g = [],
            l;
        for (l in a) {
            var p = a[l];
            p && !0 === p.active && g.push(p)
        }
        g = g.sort(function(a, b) {
            return b.score - a.score
        }).slice(0, 30);
        this.A[b] = new Candy.c.Sa(b, this, g, c, e)
    };
    this.nb = function() {
        var b = Date.now(),
            c = 0,
            e;
        for (e in a) {
            var g = a[e];
            1E4 <= b - g.La && setTimeout(g.close.bind(g), 500 * c++)
        }
    };
    setInterval(this.nb.bind(this), 29E3);
    this.Ub = {};
    this.ac = function(a) {
        Candy.b.log("add myLoadingFiles", a);
        this.ba[a] = !0
    };
    this.Nb = function(a, b, c) {
        this.m.fb(a,
            b, c);
        a = Candy.c.j.M(a);
        delete this.ba[a]
    };
    this.Ob = function(a, b, c) {
        var e = this.A[a];
        e && (this.u = c, e.success(b));
        delete this.A[a];
        delete this.ba[a]
    };
    this.dc = b = new Candy.c.bb(this.fc.bind(this), e);
    return this
};
Candy.c.bb = function(e, a) {
    function b() {
        return a.streamKey + "_" + (a.qualityKey ? a.qualityKey + "_" : "") + Candy.version
    }

    function c() {
        p = !0;
        l.connect(b()).then(h)
    }

    function d(a) {
        a.peers && e("peers", a.peers)
    }

    function f() {
        l.J().then(d)
    }

    function h(a) {
        e("connected", a.sb);
        setTimeout(function() {
            f()
        }, 1)
    }
    var g = Candy.c.F.ia(),
        l = new Candy.a.ya,
        p = !1;
    l.onMessage(function(a) {
        a.body.data && e("message", a.body.from, a.body.data)
    });
    g.addEventListener(Candy.a.i.g.na, function(a) {
        "welcome" === a.type && p && c()
    });
    Candy.V.$b(l);
    this.connect =
        c;
    this.disconnect = function() {
        p = !1;
        l.disconnect()
    };
    this.Eb = f;
    this.send = function(a, b) {
        l.send(a, b)
    };
    this.cc = b;
    return this
};
Candy.c.F = function(e) {
    if (!e && Candy.c.F.Ea) return Candy.c.F.Ea;
    Candy.c.F.Ea = this;
    this.g = [];
    this.addEventListener = function(a, b) {
        this.g[a] || (this.g[a] = []);
        this.g[a].push(b)
    };
    this.dispatchEvent = function(a) {
        if (this.g[a] && this.g[a].length)
            for (var b = 0; b < this.g[a].length; b++) this.g[a][b].apply(this, Array.prototype.slice.call(arguments).splice(1))
    }
};
Candy.c.F.ia = function() {
    return new Candy.c.F(void 0)
};
Candy.b = {};
(function() {
    function e(a, b) {
        Candy.b.enabled && console[a].apply(this, b)
    }["log", "warn", "debug", "info", "error"].forEach(function(a) {
        Candy.b[a] = function() {
            e(a, arguments)
        }
    })
})();
Candy.b.enabled = -1 != document.cookie.indexOf("candy_debug=1");
if (Candy.b.enabled) {
    var I = document.createElement("script");
    I.src = "https://hls.goodgame.ru/candy/debug.js";
    document.head.appendChild(I)
};
Candy.a.ya = function() {
    function e() {
        function a() {
            return Math.floor(65536 * (1 + Math.random())).toString(16).substring(1)
        }
        return a() + a() + "-" + a() + "-" + a() + "-" + a() + "-" + a() + a() + a()
    }

    function a(a) {
        a.reqid = Math.random().toString(36).substr(2, 9);
        var d;
        h || (h = localStorage.getItem("candyId"), h || (h = e(), localStorage.setItem("candyId", h)));
        d = h;
        a.ggid = d;
        b.dispatchEvent(Candy.a.i.g.Ca, a);
        return new Promise(function(b) {
            c[a.reqid] = b
        })
    }
    var b = Candy.c.F.ia(),
        c = {},
        d = !1,
        f = !1,
        h = !1;
    b.addEventListener(Candy.a.i.g.na, function(a) {
        if (!a.reqid) return !1;
        c[a.reqid] ? (c[a.reqid](a.body), a.body.sb = a.connid, delete c[a.reqid]) : d && d(a)
    });
    return {
        J: function() {
            return a({
                url: "candy/peers",
                body: {}
            })
        },
        send: function(b, c) {
            var d = {};
            d.to = b;
            d.data = c;
            return a({
                url: "candy/send",
                body: d
            })
        },
        Xb: function(b) {
            return a({
                url: "candy/log",
                body: b
            })
        },
        connect: function(b) {
            f = !0;
            return a({
                url: "candy/connect",
                subscribe: ["peers"],
                body: {
                    channel: b
                }
            })
        },
        disconnect: function() {
            if (!f) return !1;
            f = !1;
            return a({
                url: "candy/__leave",
                body: {}
            })
        },
        onMessage: function(a) {
            d = a
        }
    }
};
Candy.a.ya.g = {};
Candy.a.i = function() {
    function e(a) {
        if (k && 1 == k.readyState) {
            void 0 === a && (a = {});
            try {
                k.send(JSON.stringify(a))
            } catch (b) {
                Candy.b.log("ws _send2 error" + b.toString())
            }
        } else Candy.b.log("Cant send websocket " + (a.type ? a.type : a.url))
    }

    function a(a, b) {
        e({
            type: a,
            data: b
        })
    }

    function b() {
        k && (k.onclose = function() {}, k.close());
        Candy.b.warn("Websocket closed, reconnecting...");
        setTimeout(t, 3E3)
    }

    function c(b) {
        try {
            var c = JSON.parse(b.data)
        } catch (d) {
            Candy.b.log("_onMessage error" + d.toString());
            m.dispatchEvent(Candy.a.i.g.ERROR,
                d);
            return
        }
        m.dispatchEvent(Candy.a.i.g.na, c);
        switch (c.type) {
            case "welcome":
                w && a("get_all_viewers", {
                    channel: w
                });
                break;
            case "viewers":
                m.dispatchEvent(Candy.a.i.g.ab, c.data.count);
                break;
            case "remaining":
                y && y(c.data);
                y = !1;
                break;
            case "commercial":
                m.dispatchEvent(Candy.a.gc.g.kc, c.data);
                break;
            case "candy":
                m.dispatchEvent(Candy.a.K.g.$a, c.data)
        }
    }

    function d(a) {
        e(a)
    }

    function f(b, c) {
        "undefined" != typeof c && a("player_event_3", {
            name: b,
            data: c
        })
    }

    function h() {
        return k && 1 == k.readyState ? !0 : !1
    }

    function g() {
        a("unview", {
            channel: w
        })
    }

    function l() {}

    function p() {
        y = !1;
        a("stop_test_premium")
    }

    function r(b) {
        y = b;
        a("start_test_premium")
    }

    function t() {
        n || (m.addEventListener(Candy.a.i.g.za, f), m.addEventListener(Candy.a.i.g.Ca, d), Candy.a.Ba && (m.addEventListener(Candy.a.i.g.Xa, r), m.addEventListener(Candy.a.i.g.Ya, p), m.addEventListener(Candy.a.Ba.g.jc, l), m.addEventListener(Candy.a.Ba.g.lc, g)), n = !0);
        k = new WebSocket("wss://candy.goodgame.ru:8085/");
        k.onmessage = c;
        k.onclose = b;
        x || (x = setInterval(h, 1E4));
        return !0
    }
    var m = Candy.c.F.ia(),
        k, n = !1,
        x = !1,
        w = !1,
        y = !1;
    return {
        Kb: t,
        yc: function(a) {
            w = a
        },
        close: function() {
            clearInterval(x);
            k.onclose = function() {};
            k.close()
        }
    }
};
Candy.a.i.Ka = function() {
    return !!window.WebSocket
};
Candy.a.i.g = {
    ERROR: "websockets_error",
    na: "websockets_message",
    Ca: "websockets_send",
    ab: "websockets_viewers",
    za: "websockets_postevent",
    Xa: "websockets_start_test_premium",
    Ya: "websockets_stop_test_premium"
};

try {
    stManager.done('candy.min.js')
} catch (e) {}